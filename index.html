<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Movement Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
        }
        input, select, textarea, button {
            width: 100%;
            margin-bottom: 15px;
            padding: 10px;
            font-size: 1rem;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h2>Equipment Movement Form</h2>
    <form id="movementForm">
        <label>Equipment:</label>
        <input type="text" id="equipment" readonly>

        <label>Serial Number:</label>
        <input type="text" id="serialNumber" readonly>

        <label>Expiry Calibration:</label>
        <input type="text" id="expiryCalibration" readonly>

        <label>Name:</label>
        <select id="userName" required>
            <option value="">Loading users...</option>
        </select>

        <label>Movement Type:</label>
        <select id="movementType" required onchange="toggleFields()">
            <option value="">Select Type</option>
            <option value="Outgoing">Outgoing</option>
            <option value="Incoming">Incoming</option>
        </select>

        <div id="toField" class="hidden">
            <label>To:</label>
            <input type="text" id="toLocation">
        </div>

        <div id="fromField" class="hidden">
            <label>From:</label>
            <input type="text" id="fromLocation">
        </div>

        <label>Purpose:</label>
        <input type="text" id="purpose" required>

        <label>Remark:</label>
        <input type="text" id="remark" maxlength="50">

        <div id="qtyField" class="hidden">
            <label>Quantity (if consumable):</label>
            <input type="number" id="qty" min="1">
        </div>

        <button type="submit">Submit</button>
    </form>

    <script>
        let equipmentData = [];

        // Fetch equipment data
        fetch('equipment_lookup.json')
            .then(response => response.json())
            .then(data => {
                equipmentData = data;
                populateFields();
            });

        // Fetch user list
        fetch('user_list.json')
            .then(response => response.json())
            .then(users => {
                const userSelect = document.getElementById('userName');
                userSelect.innerHTML = '<option value="">Select User</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    userSelect.appendChild(option);
                });
            });

        // Get Serial Number from URL and populate fields
        function populateFields() {
            const params = new URLSearchParams(window.location.search);
            const serial = params.get('serial') || '';
            document.getElementById('serialNumber').value = serial;

            const equipment = equipmentData.find(item => item.Serial_Number === serial);
if (equipment) {
    document.getElementById('equipment').value = equipment.Equipment;

    // Convert expiry to readable format
    const expiryRaw = new Date(equipment.Expired_Calibration);
    const options = { year: 'numeric', month: 'short', day: '2-digit' };
    const formattedExpiry = expiryRaw.toLocaleDateString(undefined, options);

    document.getElementById('expiryCalibration').value = formattedExpiry;
} else {
    document.getElementById('equipment').value = 'Unknown';
    document.getElementById('expiryCalibration').value = 'Unknown';
}

        }

        function toggleFields() {
            const movementType = document.getElementById('movementType').value;
            document.getElementById('toField').classList.toggle('hidden', movementType !== 'Outgoing');
            document.getElementById('fromField').classList.toggle('hidden', movementType !== 'Incoming');
        }

        document.getElementById('movementForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = {
        serialNumber: document.getElementById('serialNumber').value,
        equipment: document.getElementById('equipment').value,
        expiryCalibration: document.getElementById('expiryCalibration').value,
        userName: document.getElementById('userName').value,
        movementType: document.getElementById('movementType').value,
        toLocation: document.getElementById('toLocation').value,
        fromLocation: document.getElementById('fromLocation').value,
        purpose: document.getElementById('purpose').value,
        remark: document.getElementById('remark').value,
        qty: document.getElementById('qty').value
    };

    fetch('https://script.google.com/macros/s/AKfycbzyMOilPmdrQ8h3FasaGEWq4Sig-53JwA61O0CopY3kJgMAHkogvk_HNv_EF572gAGbcQ/exec', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(result => {
        alert(result.message);
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Submission failed. Check server.');
    });
});

    </script>
</body>
</html>
